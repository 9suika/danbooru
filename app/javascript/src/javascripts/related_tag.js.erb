import Utility from './utility';

let RelatedTag = {};

RelatedTag.initialize_all = function() {
  RelatedTag.artists = [];
  RelatedTag.translated_tags  = [];
  $(document).on("click.danbooru", ".related-tags-button", RelatedTag.on_click_related_tags_button);
  $(document).on("click.danbooru", ".related-tags a.search-tag", RelatedTag.toggle_tag);
  $(document).on("click.danbooru", "#show-related-tags-link, #hide-related-tags-link", RelatedTag.toggle);
  $(document).on("keyup.danbooru.relatedTags", "#upload_tag_string, #post_tag_string", RelatedTag.update_selected);
  $(document).on("danbooru:update-source-data", RelatedTag.on_update_source_data);
  $(document).on("danbooru:show-post-edit-form", RelatedTag.on_show_post_edit_form);
  $(document).on("danbooru:open-post-edit-dialog", RelatedTag.on_open_post_edit_dialog);
  $(document).on("danbooru:close-post-edit-dialog", RelatedTag.on_close_post_edit_dialog);
}

RelatedTag.tags_include = function(name) {
  var current = $("#upload_tag_string,#post_tag_string").val().toLowerCase().match(/\S+/g) || [];
  return $.inArray(name.toLowerCase(), current) > -1;
}

RelatedTag.update_related_tags = function (category = "") {
  $.get("/related_tag.js", {
    "query": RelatedTag.current_tag(),
    "category": category,
    "translated_tags": RelatedTag.translated_tags.join(" "),
    "artists": RelatedTag.artists.join(" "),
  });
}

RelatedTag.on_open_post_edit_dialog = function(event) {
  $("#related-tags-container").removeClass("visible").addClass("hidden");
}

RelatedTag.on_close_post_edit_dialog = function(event) {
  $("#related-tags-container").removeClass("hidden").addClass("visible");
}

RelatedTag.on_show_post_edit_form = function(event) {
  RelatedTag.update_related_tags();
  $("#fetch-data-manual").click();
}

RelatedTag.on_click_related_tags_button = function (event) {
  const category = $(event.target).data("category");
  RelatedTag.update_related_tags(category);
  $("#related-tags-container").removeClass("hidden").addClass("visible");
}

RelatedTag.on_update_source_data = function (event, source) {
  Danbooru.RelatedTag.artists = source.artists.map(artist => artist.name);
  Danbooru.RelatedTag.translated_tags = source.translated_tags.map(tag => tag[0]);
  RelatedTag.update_related_tags();
}

RelatedTag.current_tag = function() {
  // 1. abc def |  -> def
  // 2. abc def|   -> def
  // 3. abc de|f   -> def
  // 4. abc |def   -> def
  // 5. abc| def   -> abc
  // 6. ab|c def   -> abc
  // 7. |abc def   -> abc
  // 8. | abc def  -> abc

  var $field = $("#upload_tag_string,#post_tag_string");
  var string = $field.val();
  var n = string.length;
  var a = $field.prop('selectionStart');
  var b = $field.prop('selectionStart');

  if ((a > 0) && (a < (n - 1)) && (!/\s/.test(string[a])) && (/\s/.test(string[a - 1]))) {
    // 4 is the only case where we need to scan forward. in all other cases we
    // can drag a backwards, and then drag b forwards.

    while ((b < n) && (!/\s/.test(string[b]))) {
      b++;
    }
  } else if (string.search(/\S/) > b) { // case 8
    b = string.search(/\S/);
    while ((b < n) && (!/\s/.test(string[b]))) {
      b++;
    }
  } else {
    while ((a > 0) && ((/\s/.test(string[a])) || (string[a] === undefined))) {
      a--;
      b--;
    }

    while ((a > 0) && (!/\s/.test(string[a - 1]))) {
      a--;
      b--;
    }

    while ((b < (n - 1)) && (!/\s/.test(string[b]))) {
      b++;
    }
  }

  b++;
  return string.slice(a, b);
}

RelatedTag.update_selected = function(e) {
  var current_tags = $("#upload_tag_string,#post_tag_string").val().toLowerCase().match(/\S+/g) || [];
  var $all_tags = $("#related-tags a");
  $all_tags.removeClass("selected");

  $all_tags.each(function(i, tag) {
    if (current_tags.indexOf(tag.textContent.replace(/ /g, "_")) > -1) {
      $(tag).addClass("selected");
    }
  });
}

RelatedTag.toggle_tag = function(e) {
  var $field = $("#upload_tag_string,#post_tag_string");
  var tag = $(e.target).html().replace(/ /g, "_").replace(/&gt;/g, ">").replace(/&lt;/g, "<").replace(/&amp;/g, "&");

  if (RelatedTag.tags_include(tag)) {
    var escaped_tag = Utility.regexp_escape(tag);
    $field.val($field.val().replace(new RegExp("(^|\\s)" + escaped_tag + "($|\\s)", "gi"), "$1$2"));
  } else {
    $field.val($field.val() + " " + tag);
  }
  $field.val($field.val().trim().replace(/ +/g, " ") + " ");

  RelatedTag.update_selected();

  // The timeout is needed on Chrome since it will clobber the field attribute otherwise
  setTimeout(function () { $field.prop('selectionStart', $field.val().length);}, 100);
  e.preventDefault();
}

RelatedTag.toggle = function(e) {
  $("#related-tags-container").toggleClass("visible hidden");
  e.preventDefault();
}

$(function() {
  RelatedTag.initialize_all();
});

export default RelatedTag

